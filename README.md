# YDB Phone Verification Gateway

Универсальный сервис верификации телефонных номеров для множества сайтов и платформ с системой ключей доступа и интеграцией Yandex Database.

## Оглавление
- [Основные возможности](#основные-возможности)
- [Архитектура](#архитектура)
    - [Ключевые концепции](#ключевые-концепции)
    - [Технологический стек](#технологический-стек)
    - [Настройка сайта](#настройка-сайта)
    - [Структура данных](#структура-данных)
    - [Настройка БД](#настройка-базы-данных)
- [Полный процесс работы](#полный-процесс-работы)

## Основные возможности

- **Мультисайтовость**: Один сервис для множества сайтов и клиентов
- **Система ключей доступа**: Изолированные данные для разных проектов через verification keys
- **Прием данных из различных источников**: Tilda, Telegram, WhatsApp, веб-формы
- **Верификация телефонных номеров**: Подтверждение принадлежности номера клиенту
- **Интеграция с YDB**: Надежное хранение данных в Yandex Database
- **Webhook уведомления**: Отправка верифицированных данных на внешние endpoint-ы
- **Connection pooling**: Оптимизированное управление подключениями к БД
- **Поддержка кук**: Сохранение и передача сессионных данных между сайтами

## Архитектура

### Ключевые концепции:

- **Verification Key** - уникальный идентификатор для каждого сайта/клиента
- **Изоляция данных** - автоматическое разделение данных по ключам
- **Индивидуальные webhook-ы** - отдельные endpoint-ы для каждого проекта
- **Общая инфраструктура** - единый сервис для всех клиентов

### Технологический стек

- **Node.js** - среда выполнения
- **YDB SDK** - работа с Yandex Database
- **HTTPS** - webhook-запросы
- **Serverless** - развертывание (Yandex Cloud Functions)

### Настройка сайта

Интегрировать ссылку на ваш сайт https://functions.yandexcloud.net/yandex.cloud-key?key=your_key

Формы сохраняются с привязкой к ключу

Верификационные запросы используют тот же ключ

Данные отправляются в соответствующий webhook

### Структура данных

Основные таблицы:

- **raw_submissions** - сырые данные форм с привязкой к ключу

- **webhook_endpoints** - конфигурация webhook-ов по ключам

- **incoming_verification_attempts** - логи верификации

### Настройка базы данных

**Таблица вебхуков**

```sql
CREATE TABLE webhook_endpoints (
    key Utf8 NOT NULL,
    endpoint_url Utf8,
    enabled Bool,
    created_at Timestamp,
    PRIMARY KEY (key)
);
```

**Таблица данных форм Tilda** (сохраняем ВСЕ данные)

```sql
CREATE TABLE raw_submissions (
    id Utf8 NOT NULL,
    timestamp Timestamp,
    phone Utf8,
    source Utf8,
    raw_data Json,
    verification_key Utf8,
    phone_verified Bool,
    webhook_sent Bool,
    PRIMARY KEY (id)
);
```

**Таблица логов верификационных попыток** из ТГ/WA

```sql
CREATE TABLE incoming_verification_attempts (
    id Utf8 NOT NULL,
    timestamp Timestamp,
    phone Utf8,
    source Utf8,
    verified Bool,
    found_in_submissions Bool,
    status Utf8,
    PRIMARY KEY (id)
);
```

Сгенирируйте верификационный ключ (для примера использую 73ce67a0c48338cd36b0e63d9b5736f9)

**Настройте webhook endpoint в YDB**

```sql

INSERT INTO webhook_endpoints (key, endpoint_url, enabled) 
VALUES ('73ce67a0c48338cd36b0e63d9b5736f9', 'https://your-site.com/webhook', true);
```

Настройте вебхук в вашей платформе, например, Тильда https://functions.yandexcloud.net/ваш-ключ-в-yandex-cloud?key=73ce67a0c48338cd36b0e63d9b5736f9

Сайт A → Key: "abc123" → Данные в YDB → Webhook для сайта A

Сайт B → Key: "def456" → Данные в YDB → Webhook для сайта B

## Полный процесс работы

### **Этап 1: Сохранение заявки**

- Пользователь заполняет форму на вашем сайте

- Данные отправляются на ваш вебхук URL с ключом в параметре

- Все данные сохраняются в YDB с автоматической привязкой к вашему ключу

### **Этап 2: Инициация верификации**

- Отправляется сообщение пользователю в Telegram/WhatsApp

### **Этап 3: Подтверждение номера**

- Пользователь переходит по ссылке и подтверждает номер

- Сервис находит исходную заявку по номеру телефона и ключу

- Проверяет, что заявка создана в последние 5 минут

### **Этап 4: Отправка верифицированных данных**

- Все исходные данные формы + куки отправляются в ваш webhook (из таблицы webhook_endpoints)

- Статус заявки обновляется на "верифицировано"

- Вы получаете полные данные для обработки в вашей CRM
